name: Large Amount Of Okta MFA Attempts - MLTK
id: 117c251a-2f64-45e9-8c9e-87b4b6de81f0
version: 1
date: '2022-10-06'
author: David Dorsey, Splunk
type: Anomaly
datamodel: []
description: The following analytic identifies an account that has rejected more than 2 Push notifications in a 10 minute window. 
  Modify this query for your environment by upping the count or time window.
search: '`okta` eventType=user.authentication.auth_via_mfa | bin span=10m _time
| stats count as mfa_attempts by src_user, _time | eventstats avg(mfa_attempts) as average_attempts
| apply escu_okta_mfa_attempts_v1 upper_threshold=0.001 | rename IsOutlier(mfa_attempts) as outlier | where outlier=1
| eval upper_threshold = mvindex(split(mvindex(BoundaryRanges, -1), ":"), 0)
| `security_content_ctime(_time)`
| table _time, src_user, mfa_attempts, average_attempts, upper_threshold
| `okta_large_mfa_attempts_filter`'
how_to_implement: This analytic is specific to Okta and requires Okta logs to be ingested. You must run the search Baseline Of OKTA MFA Attempts first to generate the MLTK model that this search uses. You can adjust the threshold value specified to increase or decrease the amount of anomalies you see.
known_false_positives: A large amount of OKTA MFA Attempts is not necessarily indicative of malicious behavoir. If the amount of anomalies is too high, the threshold should be adjusted. If any one account consistently creates anomalies, it can be removed using the output filter.
references:
  - https://developer.okta.com/docs/reference/api/event-types/?q=user.authentication.auth_via_mfa
tags:
  analytic_story:
  - Suspicious Okta Activity
  - Okta MFA Exhaustion
  asset_type: Infrastructure
  cis20:
  - CIS 16
  mitre_attack_id:
  - T1110
  nist:
  - DE.CM
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - src_user 
  - eventType 
  security_domain: access
  confidence: 20
  impact: 80
  risk_score: 16
  context: []
  message: $src_user$ has a large amount, $mfa_attempts$, of OKTA MFA attempts. The average is $average_attempts$ and the threshold is $upper_threshold$.
  observable:
  - name: src_user
    type: User
    role:
    - Victim
  kill_chain_phases:
  - Exploitation
